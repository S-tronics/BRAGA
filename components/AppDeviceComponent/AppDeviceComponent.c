/**********************************************************************************************************************/
/**
 * @file        AppDeviceComponent.c
 *
 * @author      Stijn Vermeersch
 * @date        24.05.2022
 *
 * @brief
 *
 *
 * \n<hr>
 * Copyright (c) 2022, S-tronics BV\n
 * All rights reserved.
 * \n<hr>\n
 */
/**********************************************************************************************************************/

/**********************************************************************************************************************/

/***********************************************************************************************************************
; V E R I F Y    C O N F I G U R A T I O N
;---------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/

/***********************************************************************************************************************
; I N C L U D E S
;---------------------------------------------------------------------------------------------------------------------*/
#include <stdio.h>
#include <stdint.h>
#include <stddef.h>
#include <string.h>
#include <stdlib.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "esp_system.h"
#include "esp_log.h"
#include "sdkconfig.h"
#include "AppDeviceComponent.h"


/**********************************************************************************************************************/

/***********************************************************************************************************************
; L O C A L   D E F I N I T I O N S   A N D   M A C R O S
;---------------------------------------------------------------------------------------------------------------------*/
#define GPIO_RED    CONFIG_BRAGA_GPIO_RED
#define GPIO_GRN    CONFIG_BRAGA_GPIO_GREEN
#define GPIO_BLU    CONFIG_BRAGA_GPIO_BLUE
#define GPIO_OUTPUT_PIN_SEL ((1ULL<<CONFIG_BRAGA_GPIO_RED)|(1ULL<<CONFIG_BRAGA_GPIO_GREEN)|(1ULL<<CONFIG_BRAGA_GPIO_BLUE))
/**********************************************************************************************************************/

/***********************************************************************************************************************
; L O C A L   T Y P E D E F S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/

/***********************************************************************************************************************
; L O C A L   F U N C T I O N   P R O T O T Y P E S
;---------------------------------------------------------------------------------------------------------------------*/
void AppDevice_initled(void);
void AppDevice_ledtask(void *arg);
/**********************************************************************************************************************/

/***********************************************************************************************************************
; L O C A L   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/
static const char *TAG = "BRAGA DEVICE";
/**********************************************************************************************************************/

/***********************************************************************************************************************
; E X P O R T E D   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/

/***********************************************************************************************************************
; L O C A L   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
static int AppDevice_compare_versions(const char *v1, const char *v2)
{
    unsigned major_v1 = 0, minor_v1 = 0, patch_v1 = 0;
    unsigned major_v2 = 0, minor_v2 = 0, patch_v2 = 0;
    sscanf(v1, "%u.%u.%u", &major_v1, &minor_v1, &patch_v1);
    sscanf(v2, "%u.%u.%u", &major_v2, &minor_v2, &patch_v2);

    if (major_v1 < major_v2)
        return -1;
    if (major_v1 > major_v2)
        return 1;
    if (minor_v1 < minor_v2)
        return -1;
    if (minor_v1 > minor_v2)
        return 1;
    if (patch_v1 < patch_v2)
        return -1;
    if (patch_v1 > patch_v2)
        return 1;

    // check if every corresponding variable is equal to eachother
    if (major_v1 == major_v2 && minor_v1 == minor_v2 && patch_v1 == patch_v2)
        return 0;
    else
        return -2;
}
/*--------------------------------------------------------------------------------------------------------------------*/
void AppDevice_initled(void)
{
    ESP_LOGI(TAG, "Init Led");
    gpio_config_t io_conf = {};
    io_conf.intr_type = GPIO_INTR_DISABLE;
    io_conf.mode = GPIO_MODE_OUTPUT;
    io_conf.pin_bit_mask = GPIO_OUTPUT_PIN_SEL;
    io_conf.pull_down_en = 0;
    io_conf.pull_up_en = 1;

    gpio_config(&io_conf);

    xTaskCreate(AppDevice_ledtask, "AppDevice_ledtask", 1024, NULL, 10, NULL);

    ESP_LOGI(TAG, "Init Led Done");
}
/*--------------------------------------------------------------------------------------------------------------------*/
void AppDevice_ledtask(void *arg)
{
    static LED_COLOR color = RED;
    while(1)
    {
        if(color == RED)
        {
            AppDevice_SetLed(color);
            color = GREEN;
        }
        else if(color == GREEN)
        {
            AppDevice_SetLed(color);
            color = BLUE;
        }
        else if(color == BLUE)
        {
            AppDevice_SetLed(color);
            color = RED;
        }
         // 500ms = 0.5 sec
        vTaskDelay((500) / portTICK_RATE_MS);   
    }
}
/*--------------------------------------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/

/***********************************************************************************************************************
; E X P O R T E D   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void AppDeviceInit(void)
{
    AppDevice_initled();
}
/*--------------------------------------------------------------------------------------------------------------------*/
int AppDevice_compare_software_version_device(const char *version)
{
    return AppDevice_compare_versions(version, CONFIG_SOFTWARE_VERSION);
}
/*--------------------------------------------------------------------------------------------------------------------*/
int AppDevice_compare_hardware_version_device(const char *version)
{
    return AppDevice_compare_versions(version, CONFIG_HARDWARE_VERSION);
}
/*--------------------------------------------------------------------------------------------------------------------*/
void AppDevice_get_unique(char *unique)
{
    uint8_t ChipID[6];
    esp_efuse_mac_get_default(ChipID);
    sprintf(unique, "%02X%02X%02X%02X%02X%02X", ChipID[0], ChipID[1], ChipID[2], ChipID[3], ChipID[4], ChipID[5]);
    
}
/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/
void AppDevice_SetLed(LED_COLOR color)
{
    switch(color)
    {
        case RED:
            gpio_set_level(GPIO_RED, 0);
            gpio_set_level(GPIO_GRN, 1);
            gpio_set_level(GPIO_BLU, 1);
            break;
        case GREEN:
            gpio_set_level(GPIO_RED, 1);
            gpio_set_level(GPIO_GRN, 0);
            gpio_set_level(GPIO_BLU, 1);
            break;
        case BLUE:
            gpio_set_level(GPIO_RED, 1);
            gpio_set_level(GPIO_GRN, 1);
            gpio_set_level(GPIO_BLU, 0);
            break;
        default:
            break;
    }
}
/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/